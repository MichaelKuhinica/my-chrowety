var OAuthSimple;
if (OAuthSimple === undefined) {
    OAuthSimple = function(s, t){
        this._secrets = {};
        if (s !== undefined) {
            this._secrets.consumer_key = s;
        }
        if (t !== undefined) {
            this._secrets.shared_secret = t;
        }
        this._default_signature_method = "HMAC-SHA1";
        this._action = "GET";
        this._nonce_chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
        this.reset = function(){
            this._parameters = {};
            this._path = undefined;
            return this;
        };
        this.setParameters = function(a){
            if (a === undefined) {
                a = {};
            }
            if (typeof a === "string") {
                a = this._parseParameterString(a);
            }
            this._parameters = a;
            if (this._parameters.oauth_nonce === undefined) {
                this._getNonce();
            }
            if (this._parameters.oauth_timestamp === undefined) {
                this._getTimestamp();
            }
            if (this._parameters.oauth_method === undefined) {
                this.setSignatureMethod();
            }
            if (this._parameters.oauth_consumer_key === undefined) {
                this._getApiKey();
            }
            if (this._parameters.oauth_token === undefined) {
                this._getAccessToken();
            }
            return this;
        };
        this.setQueryString = function(a){
            return this.setParameters(a);
        };
        this.setURL = function(a){
            if (a=="") {
				throw "No path specified for OAuthSimple.setURL";
			}
            this._path = a;
            return this;
        };
        this.setPath = function(a){
            return this.setURL(a);
        };
        this.setAction = function(a){
            if (a === undefined) {
				a = "GET";
			}
			else { 
				a = a.toUpperCase();
			}
            if (a.match("[^A-Z]")) {
				throw "Invalid action specified for OAuthSimple.setAction";
			}
            this._action = a;
            return this;
        };
        this.setTokensAndSecrets = function(a){
            if (a) {
				for (var e in a) {
					this._secrets[e] = a[e];
				}
			}
            if (this._secrets.api_key) 
                this._secrets.consumer_key = this._secrets.api_key;
            if (this._secrets.access_token) 
                this._secrets.oauth_token = this._secrets.access_token;
            if (this._secrets.access_secret) 
                this._secrets.oauth_secret = this._secrets.access_secret;
            if (this._secrets.oauth_token_secret) 
                this._secrets.oauth_secret = this._secrets.oauth_token_secret;
            if (this._secrets.consumer_key === undefined) 
                throw "Missing required consumer_key in OAuthSimple.setTokensAndSecrets";
            if (this._secrets.shared_secret === undefined) 
                throw "Missing required shared_secret in OAuthSimple.setTokensAndSecrets";
            if (this._secrets.oauth_token !== undefined && this._secrets.oauth_secret === undefined) 
                throw "Missing oauth_secret for supplied oauth_token in OAuthSimple.setTokensAndSecrets";
            return this
        };
        this.setSignatureMethod = function(a){
            if (a === undefined) 
                a = this._default_signature_method;
            if (a.toUpperCase().match(/(PLAINTEXT|HMAC-SHA1)/) === undefined) 
                throw "Unknown signing method specified for OAuthSimple.setSignatureMethod";
            this._parameters.oauth_signature_method = a.toUpperCase();
            return this
        };
        this.sign = function(a){
            if (a === undefined) 
                a = {};
            a.action !== undefined && this.setAction(a.action);
            a.path !== undefined && this.setPath(a.path);
            a.method !== undefined && this.setSignatureMethod(a.method);
            this.setTokensAndSecrets(a.signatures);
            a.parameters !== undefined && this.setParameters(a.parameters);
            this._parameters.oauth_signature = this._generateSignature(this._normalizedParameters());
            return {
                parameters: this._parameters,
                signature: this._oauthEscape(this._parameters.oauth_signature),
                signed_url: this._path + "?" + this._normalizedParameters(),
                header: this.getHeaderString()
            }
        };
        this.getHeaderString = function(a){
            this._parameters.oauth_signature === undefined && this.sign(a);
            a = "OAuth ";
            for (var e in this._parameters) 
                if (e.match(/^oauth/) !== undefined) 
                    if (this._parameters[e] instanceof
                    Array) 
                        for (var h = this._parameters[e].length, f = 0; f < h; f++) 
                            a += e + '="' + this._oauthEscape(this._parameters[e][f]) + '" ';
                    else 
                        a += e + '="' + this._oauthEscape(this._parameters[e]) + '" ';
            return a
        };
        this._parseParameterString = function(a){
            a = a.split("&");
            for (var e = {}, h = a.shift(); h; h = a.shift()) {
                h = h.split("=");
                var f = "";
                if (h[1]) 
                    f = decodeURIComponent(h[1]);
                if (e[h[0]]) 
                    if (e[h[0]] instanceof Array) 
                        e[h[0]].push(f);
                    else 
                        e[h[0]] = Array(e[h[0]], f);
                else 
                    e[h[0]] = f
            }
            return e
        };
        this._oauthEscape = function(a){
            if (a === undefined) 
                return "";
            if (a instanceof
            Array) 
                throw "Array passed to _oauthEscape";
            return encodeURIComponent(a).replace(/\!/g, "%21").replace(/\*/g, "%2A").replace(/'/g, "%27").replace(/\(/g, "%28").replace(/\)/g, "%29")
        };
        this._getNonce = function(a){
            if (a === undefined) 
                a = 5;
            for (var e = "", h = this._nonce_chars.length, f = 0; f < a; f++) {
                var l = Math.floor(Math.random() * h);
                e += this._nonce_chars.substring(l, l + 1)
            }
            return this._parameters.oauth_nonce = e
        };
        this._getApiKey = function(){
            if (this._secrets.consumer_key === undefined) 
                throw "No consumer_key set for OAuthSimple.";
            this._parameters.oauth_consumer_key = this._secrets.consumer_key;
            return this._parameters.oauth_consumer_key
        };
        this._getAccessToken = function(){
            if (this._secrets.oauth_secret === undefined) 
                return "";
            if (this._secrets.oauth_token === undefined) 
                throw "No oauth_token (access_token) set for OAuthSimple.";
            this._parameters.oauth_token = this._secrets.oauth_token;
            return this._parameters.oauth_token
        };
        this._getTimestamp = function(){
            var a = Math.floor((new Date).getTime() / 1E3);
            return this._parameters.oauth_timestamp = a
        };
        this.b64_hmac_sha1 = function(a, e, h, f){
            function l(c, b, d, g){
                if (c < 20) 
                    return b & d | ~ b & g;
                if (c < 40) 
                    return b ^ d ^ g;
                if (c < 60) 
                    return b & d | b & g | d & g;
                return b ^ d ^ g
            }
            function p(c){
                return c < 20 ? 1518500249 : c < 40 ? 1859775393 : c < 60 ? -1894007588 : -899497514
            }
            function k(c, b){
                var d = (c & 65535) + (b & 65535);
                return (c >> 16) + (b >> 16) + (d >> 16) << 16 | d & 65535
            }
            function m(c, b){
                return c << b | c >>> 32 - b
            }
            function q(c, b){
                c[b >> 5] |= 128 << 24 - b % 32;
                c[(b + 64 >> 9 << 4) + 15] = b;
                b = [80];
                for (var d = 1732584193, g = -271733879, i = -1732584194, n = 271733878, o = -1009589776, r = 0; r < c.length; r += 16) {
                    for (var v = d, w = g, x = i, y = n, z = o, j = 0; j < 80; j++) {
                        b[j] = j < 16 ? c[r + j] : m(b[j - 3] ^ b[j - 8] ^ b[j - 14] ^ b[j - 16], 1);
                        var A = k(k(m(d, 5), l(j, g, i, n)), k(k(o, b[j]), p(j)));
                        o = n;
                        n = i;
                        i = m(g, 30);
                        g = d;
                        d = A
                    }
                    d = k(d, v);
                    g = k(g, w);
                    i = k(i, x);
                    n = k(n, y);
                    o = k(o, z)
                }
                return [d, g, i, n, o]
            }
            function u(c){
                for (var b = [], d = (1 << f) - 1, g = 0; g < c.length * f; g += f) 
                    b[g >> 5] |= (c.charCodeAt(g / 8) & d) << 32 - f - g % 32;
                return b
            }
            function B(c, b){
                var d = u(c);
                if (d.length > 16) 
                    d = q(d, c.length * f);
                var g = [16];
                c = [16];
                for (var i = 0; i < 16; i++) {
                    g[i] = d[i] ^ 909522486;
                    c[i] = d[i] ^ 1549556828
                }
                b = q(g.concat(u(b)), 512 +
                b.length *
                f);
                return q(c.concat(b), 672)
            }
            function C(c){
                for (var b = "", d = 0; d < c.length * 4; d += 3) 
                    for (var g = (c[d >> 2] >> 8 * (3 - d % 4) & 255) << 16 | (c[d + 1 >> 2] >> 8 * (3 - (d + 1) % 4) & 255) << 8 | c[d + 2 >> 2] >> 8 * (3 - (d + 2) % 4) & 255, i = 0; i < 4; i++) 
                        b += d * 8 + i * 6 > c.length * 32 ? h : "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(g >> 6 * (3 - i) & 63);
                return b
            }
            function D(c, b){
                return C(B(c, b))
            }
            h || (h = "=");
            f || (f = 8);
            return D(a, e)
        };
        this._normalizedParameters = function(){
            var a = [], e = [], h = 0;
            for (var f in this._parameters) {
                if (h++ > 1E3) 
                    throw "runaway 1";
                e.unshift(f)
            }
            e = e.sort();
            pLen = e.length;
            for (var l = 0; l < pLen; l++) {
                f = e[l];
                if (!f.match(/\w+_secret/)) 
                    if (this._parameters[f] instanceof Array) 
                        for (var p = this._parameters[f].sort(), k = p.length, m = 0; m < k; m++) {
                            if (h++ > 1E3) 
                                throw "runaway 1";
                            a.push(this._oauthEscape(f) + "=" + this._oauthEscape(p[m]))
                        }
                    else 
                        a.push(this._oauthEscape(f) + "=" + this._oauthEscape(this._parameters[f]))
            }
            return a.join("&")
        };
        this._generateSignature = function(){
            var a = this._oauthEscape(this._secrets.shared_secret) + "&" + this._oauthEscape(this._secrets.oauth_secret);
            if (this._parameters.oauth_signature_method ==
            "PLAINTEXT") 
                return a;
            if (this._parameters.oauth_signature_method == "HMAC-SHA1") {
                var e = this._oauthEscape(this._action) + "&" + this._oauthEscape(this._path) + "&" + this._oauthEscape(this._normalizedParameters());
                return this.b64_hmac_sha1(a, e)
            }
            return null
        };
        return this
    };
}
