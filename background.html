<html>
<head>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/db.js"></script>
<script type="text/javascript" src="" id="language" charset="iso-8859-1"></script>
<script type="text/javascript">
var Popup = function(){return chrome.experimental.extension.getPopupView();}
var m = function(i){return i+'0000'}
var api = {
    login:'https://twitter.com/account/verify_credentials.json',
    logout:'https://twitter.com/account/end_session.json',
    rate:'https://twitter.com/account/rate_limit_status.json',
    home:'https://twitter.com/statuses/home_timeline.json',
    friends:'https://twitter.com/statuses/friends_timeline.json',
    mentions:'https://twitter.com/statuses/mentions.json',
    messages:'https://twitter.com/direct_messages.json',
    update:'https://twitter.com/statuses/update.json',
    user_show:'https://twitter.com/users/show.json',
    retweet:function(id){return 'https://twitter.com/statuses/retweet/'+id+'.json'},
    destroy:function(id){return 'https://twitter.com/statuses/destroy/'+id+'.json'},
    favorite:function(id){return 'https://twitter.com/favorites/create/'+id+'.json'},
    unfavorite:function(id){return 'https://twitter.com/favorites/destroy/'+id+'.json'},
    threely:'http://3.ly/',
    twitpic:'http://twitpic.com/show/',
    tweetphoto_view:'http://TweetPhotoAPI.com/api/TPAPI.svc/imagefromurl',
    tweetphoto_post:'http://tweetphotoapi.com/api/tpapi.svc/upload2',
};
var time = {
    profile:null,
    home:null,
    mentions:null,
    limit:null,
    home2:null,
    home3:null
};

var Logado=false,_iniciou,toush,total=0,new_count=0,new_tcount=0,OldCount=0,api_limit = null,api_checked=false,aid,oid,taid;

function Request(url, met, type, ctype){
    this.url = url;
    this.met = met;
    this.type = type ? type : "json";
    this.dados = null;
    this.sucesso = null;
    this.erro = null;
    this.contentType = ctype ? ctype : "application/x-www-form-urlencoded",
    this.init = function(){
      $.ajax({
            url: this.url,
            type: this.met,
            data: this.dados,
            dataType: this.type,
            contentType: this.contentType,
            success: this.sucesso,
            error: this.erro,
         }
      );
    }
}

function SinceDate(TD){
    var a = new Date(TD);
    return a.getDate()+'/'+(a.getMonth()+1)+'/'+a.getFullYear();
}

function ApiDate(TD){
    var a = new Date(TD);
    return a.getHours()+':'+a.getMinutes()+':'+a.getSeconds();
}

function TweetData(TD) {
  var TD = Date.parse(TD);
  var Calc = (new Date().getTime() - TD) / 1000;
  if(Calc < 15) {
          return Traduz('just_now');
  } else if(Calc < 60) {
          return Traduz('less_than_a_minute_ago');
  } else if(Calc < 60 * 60) {
          var Min = parseInt(Calc / 60);
          var s = Traduz('minute_ago').replace('%s', Min);
              s = s.replace('&', ((Min > 1) ? "s" : ""));
          return s;
  } else if(Calc < 60 * 60 * 24) {
          var Hor = parseInt(Calc / (60 * 60));
          var s = Traduz('about_hour_ago').replace('%s', Hor);
              s = s.replace('&', ((Hor > 1) ? "s" : ""));
          return s;
  } else if(Calc < 60 * 60 * 24 * 30) {
          var Day = parseInt(Calc / (60 * 60 * 24));
          var s = Traduz('about_day_ago').replace('%s', Day);
              s = s.replace('&', ((Day > 1) ? "s" : ""));
          return s;
  } else if(Calc < 60 * 60 * 24 * 30 * 12) {
          var Month = parseInt(Calc / (60 * 60 * 24 * 30));
          var s = Traduz('about_month_ago').replace('%s', Month);
              s = s.replace('&', ((Month > 1) ? "es" : ""));
          return s;
  } else {
          return Traduz('years_ago');
  }
}

var tws = {
    home:{
      total:0,
      last:0,
      new_count:0,
      tweets:[],
      tw:[],
    }
};

function LoadLang(){
    var lg = config.language;
    $('#language').attr('src', 'lang/'+lg+'.js');
}

function Traduz(s){
  return language[language.id][s];
}

function LoadConfig(){
    console.log('LoadConfig()');
    if(db.pega('config')){
        console.log('LoadConfig() > Definida');
        config = S2J(db.pega('config'));
    }else{
        //var a = J2S(DefaultConfig);
        //config = S2J(a);
        console.log('LoadConfig() > Padrão');
        config = DefaultConfig;
    }
}

function ReLoadConfig(){
    //Chrowety.logout(true);
    window.clearInterval(time.home);
    LoadConfig();
    time.home = setInterval('Chrowety.home.Since()', m(config.refresh.home));
    //init();
}

var config = {};
var DefaultConfig = {
    start_count:{
      home:10,
      mentions:10,
      messages:10,
      favorites:10
    },
    old_count:{
      home:10,
      mentions:10,
      messages:10,
      favorites:10
    },
    refresh:{
      home:3,
      mentions:5,
      messages:7,
      favorites:7,
    },
    language:'en'
};

function Zerar(){
    Chrowety.home.Clean();
    chrome.browserAction.setBadgeText({text:''});
}

function J2S(obj){
    return JSON.stringify(obj);
}

function S2J(str){
    return JSON.parse(str);
}


function Sortear(ob, campo, reverso){
    var ob2 = ob;
    var SortFunc = function(field, reverse, primer){

       reverse = (reverse) ? -1 : 1;

       return function(a,b){

           a = a[field];
           b = b[field];

           if (typeof(primer) != 'undefined'){
               a = primer(a);
               b = primer(b);
           }

           if (a<b) return reverse * -1;
           if (a>b) return reverse * 1;
           return 0;

       }
    };

    return ob2.sort(SortFunc(campo, reverso, parseInt));
}




function CacheTweets(){
    var user     = db.pega('user');

    var _tws     = J2S(tws);

    db.salva(user+'_TwCache', true);
    db.salva(user+'_tws', _tws);
}

function RateLimit(func){
  $.get(api.rate, null, function(json){
    api_limit = json.remaining_hits;
    db.salva('api_limit', json.remaining_hits);
    db.salva('api_reset_time', json.reset_time);
    if(api_limit > 0){
        api_checked = true;
        if(typeof func == 'function'){eval(func)};
    }else{
        console.log('API Check: Limit Exceeded');
        Popup().RefreshLimit(new_count);
    }
  }, "json");
}

function CheckLimit(r){
    RateLimit(r);
}

function ClearUnreads(tm){
    console.log('Cleaning Unreads');
    tws.home.new_count = 0;
    chrome.browserAction.setBadgeText({text:''});
    for(id in tws[tm].tweets){
        tws[tm].tweets[id].read = true;
    }
}

function SalvaProfile(json){
  db.salva('id', json.id);
  db.salva('user', json.screen_name);
  db.salva('nome', json.name);
  db.salva('foto', json.profile_image_url);
  db.salva('info', json.description);
  db.salva('local', json.location);
  db.salva('seguidores', json.followers_count);
  db.salva('seguindo', json.friends_count);
  db.salva('favoritos', json.favourites_count);
  db.salva('profile_view', J2S({}));
}

// ******
/*
function ShowMore(tm){
  Chrowety[tm].Max();
}
*/

function ContaTweets(){
    var home=0;
    var id=null,fid=null,fit=null;
    var tw = Sortear(tws.home.tweets, 'id', false);
    for(a in tw){
      home++;
      id = tw[a].id;
      if(home == 1){Chrowety.home.primeiro_lista = id;fid=id}
      Chrowety.home.ultimo = id;
    }
    //Chrowety.home.primeiro = id;
    console.log('ContaTweet - Home: '+home+' LastID: '+id+' FirstID: '+fid+' First_In: '+Chrowety.home.primeiro_lista);
    tws.home.total = home;
}

var fec = {
    ByTid:function(tm, tid, del){
        var a = tws[tm].tweets;
        for(i in a){
            if(a[i].id == tid){
                if(del){
                  delete tws[tm].tweets[i];
                }
                //console.log('Deletado: '+tid);
                return a[i];
                break;
            }else if(a[i].retweeted_status && a[i].retweeted_status.id == tid){
                if(del){
                  delete tws[tm].tweets[i];
                }
                //console.log('Deletado: '+tid);
                return a[i];
                break;
            }
        }
    },
    refresh:function(tm){
        var ob = tws[tm].tweets;
        for(id in ob){
            ob[id].html = Layout(ob[id], tm);
        }
    },

    ref:function(i, tm){
        var ob = tws[tm].tweets[i];
            ob.html = Layout(ob, tm);
        return ob.html;
    },

    html:function(tm){
        var i = 0;
        var re='';
        var ob = Sortear(tws[tm].tweets, 'id', true);
        //var total = Chrowety[tm].mostrando ? Chrowety[tm].mostrando : config.start_count[tm];
        var total = config.start_count[tm];
        var ia = 0;
        for(id in ob){
            if(i > total)break;
            if(ob[id].id == ia)continue;
            re = re+fec.ref(id, tm);
            ia = ob[id].id;
            Chrowety[tm].primeiro_lista = Chrowety[tm].primeiro =  ia;
            i++;
        }
        Chrowety[tm].mostrando += i;
        //ContaTweets();
        return re;
    }
}

/* CHROWETY CONTROLLER */
var Chrowety = {

    profile_last_view: null, // nome do usuario sendo visualizado

    // @lembra
    // @login
    login:function(lembra, login){
      console.log('Chrowety.login()');
      var Login = new Request(api.login, 'get');
          Login.sucesso = function(json){
              db.salva('z_z', login);
              CheckLimit();
              time.profile = window.setInterval('Chrowety.profile()', m(20));
              time.limit = window.setInterval('CheckLimit()', m(3));
              console.log('Logado...');
              Logado = true;
              db.salva('lembra', lembra);
              db.salva('modo_retweet', 'normal');
              SalvaProfile(json);
              Popup().LoginStatus(Traduz('sucess_login'));
              Popup().init();
              console.log('Chrowety.login() > OK');
              Chrowety.home.Run('LT.home()');
          };
          Login.erro = function(){
              Popup().LoginStatus("Login failed, check your credentials or connection...");
              console.log('Chrowety.login() > FAIL');
          }
          Login.init();
    },

    logout:function(lembra){
      console.log('Chrowety.logout()');
      jQuery.ajaxSetup({'beforeSend': function(xhr){xhr.setRequestHeader("Authorization", "Basic "+db.pega('z_z'))}});
      var Logout = new Request(api.logout, 'post');
          Logout.sucesso = function(){
                window.clearInterval(time.limit);
                window.clearInterval(time.home);
                console.log('Chrowety.logout() > OK');
                Zerar();
                //db.limpa();
                if(!lembra){db.deleta('lembra')}
                Logado = false;
          };
          Logout.erro = function(){
                console.log('Chrowety.logout() > FAIL');
          };
          Logout.init();
    },

    // Atualiza informações do perfil
    profile:function(){
      console.log('Chrowety.profile()');
      var Profile = new Request(api.login, 'get');
          Profile.sucesso = function(json){
            console.log('Chrowety.profile() > OK');
            SalvaProfile(json);
          };
          Profile.erro = function(){
            console.log('Chrowety.profile() > FAIL');
          };
          Profile.init();
    },

    user:function(uname){
      var U = S2J(db.pega('profile_view'));
      if(U && U[uname]){
        console.log('Cache do Usuario encontrado');
        Popup().ShowUserOK(U[uname]);
        return false;
      }

      console.log('Usuario sem Cache');

      var User = new Request(api.user_show, 'get');
          User.dados = {screen_name: uname};
          User.sucesso = function(json){
            console.log('Chrowety.user() > OK');
            var U = S2J(db.pega('profile_view'));
            U[uname] = json;
            db.salva('profile_view', J2S(U));
            Popup().ShowUserOK(json);
          };
          User.erro = function(){
            console.log('Chrowety.user() > FAIL');
            Popup().ShowUserERRO();
          };
          User.init();
    },

    /*
     * @s String - texto do tweet
     * @reply_id Number - id do tweet de resposta
     * @tm String - Timeline do tweet
     */
    update:function(s, reply_tid, tm){
      var src = 'chrowety';//'blu';//'friendfeed';//'twidroid';//'tweetdeck';//'seesmicdesktop';//
      var Up = new Request(api.update, 'post');
          Up.dados = reply_tid ? {status: s, source: src, in_reply_to_status_id: reply_tid} : {status: s, source: src};
          Up.sucesso = function(w){
            console.log('Tweet send: '+s);
            ht = Layout(w, tm);
            tws.home.total++;
            tws.home.tweets[tws.home.total] = w;
            tws.home.tweets[tws.home.total].html = ht;
            //> Salva o perfil
            var U = S2J(db.pega('profile_view'));
            var ts = J2S(w.user);
                ts = S2J(ts); // POG pra tirar relacionamento
                ts.status = J2S(w);
                ts.status = S2J(ts.status);
                delete ts.status.user;
            U[ts.screen_name] = ts;
            db.salva('profile_view', J2S(U));
            Chrowety.home.ultimo = w.id;
           //ContaTweets();
                if(reply_tid){
                    Popup().ReplyOK(reply_tid, tm);
                    console.log('Return ReplyOK');
                }else{
                    Popup().UpdateOK(ht, tm);
                    console.log('Return UpdateOK');
                }
          };
          Up.erro = function(){
                console.log('Chrowety.update() > FAIL');
          };
          Up.init();
    },

    deleta:function(tid, time){
      var del = new Request(api.destroy(tid), 'post');
          del.sucesso = function(){
            //delete tws.home.tweets[tid];
            fec.ByTid(time, tid, true);
            console.log('Tweet Deleted: '+tid);
          };
          del.erro = function(){
                console.log('Chrowety.deleta() > FAIL');
          };
          del.init();
    },

    retweet:function(tid){
      var rt = new Request(api.retweet(tid), 'post');
          rt.sucesso = function(){
            console.log('Retweet send: '+tid);
            Popup().RetweetOK(tid);
          };
          rt.erro = function(){
                console.log('Chrowety.retweet() > FAIL');
          };
          rt.init();
    },

    fav_active:false,
    favorite:function(tid, time){
      Chrowety.fav_active = true;
      var fav = new Request(api.favorite(tid), 'post');
          fav.sucesso = function(){
            console.log('Favoriting tweet: '+tid);
            fec.ByTid(time, tid).favorited = true;
            //eval('tws.'+time).tweets[tid].favorited = true;
            Popup().FavOK(tid, true, time);
            Chrowety.fav_active = false;
          };
          fav.erro = function(){
                console.log('Chrowety.favorite() > FAIL');
          };
          fav.init();
    },

    unfav_active:false,
    unfavorite:function(tid, time){
      Chrowety.unfav_active = true;
      var fav = new Request(api.unfavorite(tid), 'post');
          fav.sucesso = function(){
            console.log('Unfavoriting tweet: '+tid);
            fec.ByTid(time, tid).favorited = false;
            //eval('tws.'+time).tweets[tid].favorited = false;
            Popup().FavOK(tid, false, time);
            Chrowety.unfav_active = false;
          };
          fav.erro = function(){
                console.log('Chrowety.unfavorite() > FAIL');
          };
          fav.init();
    },

    home: {
        _loaded:false,
        scroll:0,
        mostrando:0,
        ultimo:null,
        primeiro:null,
        primeiro_lista:null,

        Clean:function(){
            Chrowety.home._loaded = false;
            Chrowety.home.ultimo = null;
            Chrowety.home.primeiro = null;
            Chrowety.home.primeiro_lista = null;
            Chrowety.home.scroll = 0;
            tws = null;
            tws = {home:{total:0,last:0,new_count:0,tweets:[]}};
        },

        Notify:function(n){
            tws.home.new_count += n;
            if(tws.home.new_count > 0){
                var c = tws.home.new_count;
                chrome.browserAction.setBadgeText({text:''+c});
                try{
                  Popup().RefreshResult(c, 'home');
                }catch(e){}
                console.log('Chrowety.home.Notify(): '+c);
                //ContaTweets();
            }
        },

        Run:function(callback){
            console.log('Chrowety.home.Run()');
            var Run = new Request(api.home, 'get');
                Run.dados = {count:config.start_count.home};
                Run.sucesso = function(json,s){
                              var id;
                              $.each(json.reverse(),function(n,w){
                                taid = w.id;
                                id = w.retweeted_status ? w.retweeted_status.id : w.id;
                                aid = id;
                                tws.home.total++;
                                tws.home.tweets[tws.home.total] = w;
                                tws.home.tweets[tws.home.total].read = true;
                                ht = Layout(tws.home.tweets[tws.home.total], 'home');
                                tws.home.tweets[tws.home.total].html = ht;
                                if(n == 0){Chrowety.home.primeiro_lista = taid}
                              });
                              Chrowety.home._loaded = true;
                              Chrowety.home.ultimo = taid;
                              //ContaTweets();
                              time.home = setInterval('Chrowety.home.Since()', m(config.refresh.home));
                              if(callback){
                                try{eval('Popup().'+callback)}catch(e){}
                              }
                };
                Run.erro = function(){
                    console.log('Chrowety.Run() > FAIL');
                };
                Run.init();
        },
        Since:function(since){
            console.log('Chrowety.home.Since()');
            ContaTweets();
            var last = since ? since : Chrowety.home.ultimo;
            var novs = 0;
            var Since = new Request(api.home, 'get');
                Since.dados = {since_id: last};
                Since.sucesso = function(json,s){
                              var id;
                              $.each(json.reverse(),function(n,w){
                                n++;
                                taid = w.id;
                                id = w.retweeted_status ? w.retweeted_status.id : w.id;
                                aid = id;
                                tws.home.total++;
                                tws.home.tweets[tws.home.total] = w;
                                tws.home.tweets[tws.home.total].read = false;
                                ht = Layout(tws.home.tweets[tws.home.total], 'home');
                                tws.home.tweets[tws.home.total].html = ht;
                                //> Salva o perfil
                                var U = S2J(db.pega('profile_view'));
                                var ts = J2S(w.user);
                                    ts = S2J(ts); // POG pra tirar relacionamento
                                    ts.status = J2S(w);
                                    ts.status = S2J(ts.status);
                                    delete ts.status.user;
                                U[ts.screen_name] = ts;
                                db.salva('profile_view', J2S(U));
                                console.log('Since++ '+n);
                                novs = n;
                              });
                              Chrowety.home.ultimo = taid;
                              console.log('Chrowety.home.Since() > New '+novs+' tweets');
                              Chrowety.home.Notify(novs);
                };
                Since.erro = function(){
                    console.log('Chrowety.Since() > FAIL');
                };
                Since.init();
        },
        Max:function(max){
            console.log('Chrowety.home.Max()');
            var first = max ? max : Chrowety.home.primeiro;
            var re = '';
            var Max = new Request(api.home, 'get');
                Max.dados = {count: config.old_count.home, max_id: first};
                Max.sucesso = function(json,s){
                              var id;
                              $.each(json,function(n,w){
                                if(n == 0){return;}
                                taid = w.id;
                                id = w.retweeted_status ? w.retweeted_status.id : w.id;
                                oid = id;
                                ht = Layout(w, 'home', 'read');
                                re = re+ht;
                                tws.home.total++;
                                tws.home.tweets[tws.home.total] = w;
                                tws.home.tweets[tws.home.total].html = ht;
                              });
                              Chrowety.home.primeiro = taid;
                              Popup().ShowMoreOK(re, 'home');
                              //eval('Popup().'+callback);
                };
                Max.erro = function(){
                    console.log('Chrowety.Max() > FAIL');
                };
                Max.init();
        },
    },


    mentions: {

    },
};

function Layout(w, time){
  var user = w.user.screen_name,
  nome = w.user.name,
  classic_txt = w.retweeted_status ? w.text : '';
  txt = w.retweeted_status ? w.retweeted_status.text : w.text,
  foto = w.user.profile_image_url,
  data = w.created_at,
  source = w.source,
  tid = w.id;

  read = w.read ? 'read' : 'unread';

  var in_reply = w.in_reply_to_status_id ? '<a class="cinza p8" href="http://twitter.com/'+w.in_reply_to_screen_name+'/status/'+w.in_reply_to_status_id+'" onclick="Link(this);" title="'+Traduz('in_reply_to')+' '+w.in_reply_to_screen_name+'">'+Traduz('in_reply_to')+' '+w.in_reply_to_screen_name+'</a>' : '';
  var Retweeted = '';
  var RT  = db.pega('modo_retweet') == 'normal' ?
  '<a onclick="Retweet('+tid+', \''+time+'\');" class="opts fr" title="'+Traduz('retweet')+'">'+Traduz('retweet')+'</a>' :
  '<a onclick="RetweetOficial('+tid+');" class="opts fr" title="'+Traduz('retweet')+'">'+Traduz('retweet')+'</a>';

  if(w.retweeted_status){
    rt_user = w.user.screen_name;

    RT = db.pega('user') == user ? '' : RT;
    user = w.retweeted_status.user.screen_name;
    nome = w.retweeted_status.user.name;
    txt = w.retweeted_status.text;
    foto = w.retweeted_status.user.profile_image_url;
    data = w.retweeted_status.created_at;
    source = w.retweeted_status.source;
    tid = w.retweeted_status.id;
    in_reply = w.retweeted_status.in_reply_to_status_id ?
    '<a class="cinza p8" href="http://twitter.com/'+w.retweeted_status.in_reply_to_screen_name+'/status/'+w.retweeted_status.in_reply_to_status_id+'" onclick="Link(this);" title="'+Traduz('in_reply_to')+' '+w.retweeted_status.in_reply_to_screen_name+'">'+Traduz('in_reply_to')+' '+w.retweeted_status.in_reply_to_screen_name+'</a>'
    : '';
    txt = '<span class="rts" title="'+Traduz('retweeted_by')+' '+rt_user+'">Retweeted</span> <a class="reter" nohref="http://twitter.com/'+user+'" onclick="ShowUser(\''+user+'\')">'+user+'</a> '+txt;
    Retweeted = '<br /><span class="cinza p8" title="'+Traduz('retweeted_by')+' '+rt_user+'">'+Traduz('retweeted_by')+' </span><a class="reter p8" nohref="http://twitter.com/'+rt_user+'" onclick="ShowUser(\''+rt_user+'\')">'+rt_user+'</a>';
    Retweeted += ' <span class="opts2">(<span class="cinza p8 tweetdata" data="'+w.created_at+'"></span>)</span>';
    RT = '<a onclick="RetweetRT('+tid+', \''+time+'\');" class="opts fr" title="'+Traduz('retweet')+'">'+Traduz('retweet')+'</a>';
  }

  var fav = w.favorited ? '<a id="tweet_fav_'+tid+'" class="star fr" fav="true" onclick="UnFavorite('+tid+', \''+time+'\')" title="'+Traduz('unfavorite')+'">'+Traduz('unfavorite')+'</a><img id="tweet_ifav_'+tid+'" src="" class="fr dn">' :
                      '<a id="tweet_fav_'+tid+'" class="star opts fr" onclick="Favorite('+tid+', \''+time+'\')" title="'+Traduz('favorite')+'">'+Traduz('favorite')+'</a><img id="tweet_ifav_'+tid+'" src="" class="fr dn">';

  var del = db.pega('user') == user ? '<a onclick="Deleta('+tid+', \''+time+'\');" class="lixo opts fr" title="'+Traduz('delete')+'">'+Traduz('delete')+'</a>' : '';

  // Links Normais
  txt = txt.replace(/(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?^twitpic^tweetphoto^pic.gd^youtube.com\/watch\?v=)(\s|&gt;|$)/g,' <a class="url" title="$2" href="$2" onclick="Link(this);">$2</a> ');

  //Twitpic
  txt = txt.replace(/((https?):\/\/twitpic.com\/([a-zA-Z_0-9]*|$))/g,' <a class="url" nohref="$1" title="$1" onclick="Twitpic(\'$3\');">$1</a>');

  //Tweetphoto | Pic.gd
  txt = txt.replace(/((https?):\/\/(tweetphoto.com\/|www.tweetphoto.com\/|pic.gd\/)([a-zA-Z_0-9]*|$))/g,' <a class="url" nohref="$1" title="$1" onclick="Tweetphoto(\'$1\');">$1</a>');

  //YouTube http://www.youtube.com/watch?v=sG5lpGdNd5E
  txt = txt.replace(/((https?):\/\/(www.youtube.com\/watch\?v=|youtube.com\/watch\?v=)([a-zA-Z_0-9]*|$))/g,' <a class="url" nohref="$1" title="$1" onclick="Youtube(\'$4\');">$1</a>');


  //Links sem Http
  txt = txt.replace(/(^|&lt;|\s)((www).+?)(\s|&gt;|$)/g,' <a class="url" title="$2" href="http://$2" onclick="Link(this);">$2</a> ');

  //Links de Usuarios
  txt = txt.replace(/(@|$)([a-zA-Z_0-9]*|$)/g,' $1<a class="usuario" title="$2" nohref="http://twitter.com/$2" onclick="ShowUser(\'$2\')">$2</a>');

  // Links Normais
  txt = txt.replace(/(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g,' <a class="url" title="$2" href="$2" onclick="Link(this);">$2</a> ');

  //Links de Tags
  txt = txt.replace(/(^|&lt;|a-zA-Z_0-9|\s)(#|$)([çÇáéíóúýÁÉÍÓÚÝàèìòùÀÈÌÒÙãõñäëïöüÿÄËÏÖÜÃÕÑâêîôûÂÊÎÔÛ_a-zA-Z_0-9]*|$)/g,' $2<a class="tag" title="$3" href="http://twitter.com/search?q=%23$3" onclick="Link(this);">$3</a>');

  txt = txt.replace('>@'+db.pega('user'), ' class="usuario photo bold">@'+db.pega('user'));

  source = source.replace('rel=\"nofollow\"', 'class="cinza p8 source" onclick="Link(this);"');
  var careator = !w.retweeted_status ?
                    '<a title="'+nome+'" nohref="http://twitter.com/'+user+'" onclick="ShowUser(\''+user+'\')">'+
                        '<span class="creator">'+user+'</span>'+
                    '</a><br />' : '';
  var creator = '';

  if(w.reply_backup){
    var reply_backup = w.reply_backup;
    //var reply_backup = '';
    var cdn = 'dn'
  }else{
    var reply_backup = '';
    var cdn = 'dn';
  }

  r =
  '<div id="tweply_'+tid+'" class="tweply" title="'+nome+' ('+user+')">' +
            '<div class="twet '+read+'">' +
                '<div class="text">' +
                    '<input id="tid_'+tid+'" value="'+tid+'" type="hidden" />' +
                    '<input id="user_'+tid+'" value="'+user+'" type="hidden" />' +
                    '<input id="data_'+tid+'" value="'+data+'" type="hidden" />' +
                    '<a title="'+nome+'" nohref="http://twitter.com/'+user+'" onclick="ShowUser(\''+user+'\')" class="fl">' +
                      '<img class="photo" alt="'+nome+'\'s Picture" title="'+nome+' Avatar" src="'+foto+'" width="45" height="45" />' +
                    '</a>' +
                    creator+
                    fav+
                    '<span id="texto_'+tid+'" class="texwt" data="'+classic_txt+'">'+txt+'</span>' +
                '</div>' +
                '<div class="cinza">' +
                    '<span><a title="'+tid+'" class="cinza p8 tweetdata" href="http://twitter.com/'+user+'/status/'+tid+'" onclick="Link(this);" data="'+data+'"></a></span>' +
                    ' via '+source+' ' +
                    in_reply +
                    RT +
                    del +
                    Retweeted +
                '</div>' +
                '<a onclick="Reply('+tid+', false, \''+time+'\');" class="r" title="'+Traduz('reply')+' '+user+'">'+Traduz('reply')+'</a>' +
            '</div>' +

            '<div id="reply_'+tid+'" class="reply '+cdn+'" title="'+Traduz('reply')+' '+user+'">' +
              '<textarea onkeyup="Count('+tid+', \''+time+'\')" id="reply_text_'+tid+'" class="p8" backup="'+reply_backup+'"></textarea><br />' +
              //'<a onclick="ShortLink('+tid+', \''+time+'\')" title="Short Links" class="p8">Short Links</a><br />'+
              '<span id="retweet_choice_'+tid+'" class="dn">' +
                  '<button id="rt_now_'+tid+'" onclick="RetweetOficial('+tid+')" title="'+Traduz('retweet_now')+'">'+Traduz('retweet_now')+'</button>   ' +
                  '<button id="edit_rt_'+tid+'" onclick="RetweetEdit('+tid+', \''+time+'\');" title="'+Traduz('edit')+'">'+Traduz('edit')+'</button>  ' +
                  '<a onclick="ReplyCancel('+tid+', \''+time+'\')" class="p8" title="'+Traduz('cancel')+'">'+Traduz('cancel')+'</a>' +
              '</span>' +
              '<span id="reply_rt_'+tid+'" class="dn">' +
                 '<span class="short" title="Short a Link"><button onclick="ShortLink('+tid+', \''+time+'\')"  class="button fl"><img src="img/link.png" height="16" /></button><input onfocus="ShowShortLink('+tid+')" _onblur="HideShortLink('+tid+')" active="false" class="short_link_url fl" id="short_link_url_'+tid+'" type="text" /></span><br class="cb"/>' +
                 '<button id="botao_'+tid+'" onclick="doReply('+tid+', \''+time+'\');" title="'+Traduz('done')+'">'+Traduz('done')+'</button>   ' +
                 '<a onclick="ReplyCancel('+tid+', \''+time+'\')" title="'+Traduz('cancel')+'" class="p8">'+Traduz('cancel')+'</a>' +
              '</span>' +
              '<span id="count_'+tid+'" class="reply_left">140</span>' +
              '<span id="reply_status_'+tid+'" class="reply_left"></span>' +
            '</div>' +
    '</div>';
  return r;
}

function pause(milliseconds) {
	var dt = new Date();
	while ((new Date()) - dt <= milliseconds) { /* Do nothing */ }
}


var Utils = {
    currentURL:null,

    GetTabUrl: function(){
        chrome.tabs.getSelected(null, function(tab) {
               Utils.currentURL = tab.url;
        });
    },

    Short:{

      link:null,

      Threely:function(LongUrl, tid, tm){
        console.log('Shorting URL: '+LongUrl+' With: 3.ly');
        var shorted;
        var Ly = new Request(api.threely, 'get', 'html');
            Ly.dados = {api: 'em5893833', u: LongUrl};
            Ly.sucesso = function(url){
                Utils.Short.link = url;
                shorted = url;
                console.log(url);
                Popup().ShortLinkOK(tid, tm, url);
            };
            Ly.erro = function(e){
              console.log('Ouve um erro no Threely');
            }
            Ly.init();
        return shorted;
      },

    },

    Yfrog:{
        thumb:function(url){
            return url+'.th.jpg';
        }
    },

    Twitpic:{
        vendo:null,
        thumb:function(id){
            Utils.Twitpic.vendo = id;
            var size = 'thumb';
            return api.twitpic+size+'/'+id;
        }
    },

    Tweetphoto:{

        post:function(){
            var tp = new Request(api.tweetphoto_post, 'post');
                tp.dados = {
                    TPAPIKEY:'f3ccec03ac7803188d3ce28dd4867334',
                    TPMIMETYPE: 'image/jpg',
                };
        },

        thumb:function(url){
            var size = 'medium';
            return api.tweetphoto_view+'?size='+size+'&url='+url;
        }
    }

};

function Logout(){
    Chrowety.logout();
}

function AutoLogin(){
    console.log('AutoLogin()');
    Logado = true;
    jQuery.ajaxSetup({'beforeSend': function(xhr){xhr.setRequestHeader("Authorization", "Basic "+db.pega('z_z'))}});
    CheckLimit();
    time.profile = window.setInterval('Chrowety.profile()', m(20));
    time.limit = window.setInterval('CheckLimit()', m(3));
    Chrowety.home.Run('LT.home()');
}

function Login(user,senha,lembra){
  console.log('Login()');
  var login = btoa(user+':'+senha);
  jQuery.ajaxSetup({'beforeSend': function(xhr){xhr.setRequestHeader("Authorization", "Basic "+login)}});
  Chrowety.login(lembra, login);
}

function BrowserAction(){
  var canvas = document.getElementById('canvas');
  canvasContext = canvas.getContext('2d');
  chrome.browserAction.setBadgeBackgroundColor({color:[119, 190, 190, 190]});
  //chrome.browserAction.setBadgeText({text:"0"});
  chrome.browserAction.setIcon({path:"favicon.ico"});
  chrome.browserAction.setTitle({title:"Chrowety"});
}


function init() {
  BrowserAction();
  LoadConfig();
  LoadLang();
  if(db.pega('lembra')){
    AutoLogin();
  }
}
$(document).ready(init);
</script>
</head>
<body>
<canvas id="canvas" width="27" height="23"></canvas>
</body>
</html>